

##########################################################
## NEW OPTIMIZER RUN: 2026-02-26 18:10:47.428001
##########################################################

 
============================================================ 
R PLUMBER API TRACE - /optimizer/run 
============================================================ 
[R-1] API Endpoint Called: POST /optimizer/run 
[R-2] Plumber File: c:/PromoGen/Bilal_local_dep/Multippg-Ui updatedbranch/Client_local_RB_promo/RB_PromoGen_R/backend/r_engine/plumber_api.R 
------------------------------------------------------------ 
[R-3] SETTINGS Received: 
      goal (code): GM%NR 
      goal (full name): Gross Margin % of NR 
      goal_sign: Max 
      slot_criterion: Seasonality Trend 
      run_type: Run Unconstrained Optimization 
      roi_type: Incremental GM ROI 
------------------------------------------------------------ 
[R-4] FILTERS Received: 
      retailer: Carrefour 
      brand: Bar Soap 
      ppg: D77 
      date_type: monthly 
      start_month: Jan 
      end_month: Apr 
      start_quarter: Q1 
      end_quarter: Q2 
------------------------------------------------------------ 
[R-5] CONSTRAINTS Received: 
      GM Range: UNCONSTRAINED (not specified by user) 
      TS%NR Range: UNCONSTRAINED (not specified by user) 
      TS%NIS Range: UNCONSTRAINED (not specified by user) 
      NR Range: $ 0.0  - $ 1e+20  [ACTIVE] 
------------------------------------------------------------ 
[R-6] RESTRICTIONS Received: 
      Price Range: AED 8.0  - AED 12.33 
      Slots Range: 5 - 6 
      Display Range: 0 - 10 (min-max number of Display promos) 
      Flyer Range: 0 - 10 (min-max number of Flyer promos - future use) 
      Investment Range: AED 836.0  - AED 8363190.0 
      Mechanics: tpr,display 
------------------------------------------------------------ 
[R-6a] OPTIMIZATION MODE SELECTION: 
      >>> MODE: UNCONSTRAINED OPTIMIZATION <<< 
      Will execute: optimization() with standard (non-LSM) data 
      Data sources: SP_opti_best_seq, shiny_ip_events, prod_const 
      Final optimization_mode: unconstrained 
------------------------------------------------------------ 
[R-7] Loading processed data from: C:/PromoGen/Bilal_local_dep/Multippg-Ui updatedbranch/Client_local_RB_promo/RB_PromoGen_R/data/data_prep_op.RData 
[R-7a] Force-reloading data_prep_op from disk to ensure latest data... 
Loaded data_prep_op.RData successfully
[R-7a] Successfully reloaded data_prep_op from disk 

========== COMPONENT [[6]] DEBUG ==========
Class: data.table, data.frame 
Rows: 936 
Columns: 18 
Column names: PPG, SECTOR 2, TRADING COMPANY, PRODUCT RANGE, FORMAT, PPG_Description, Tesco_Week_No, Base_Units, RSP_Unit, Net_Cost_Unit, FM%, COGS_Unit, BIP_Case, OID, No_Of_Units, STP_Unit, OID_Unit, UNCR_Unit 
PPG values: D74, D77, D83, D8D, D8F, D8G, D8I, D90, D91, D9N, T03, T09, T15, T16, T18, T19, T60, T68, T70, T71, T73, T74, T75, T76, T77, T78 
============================================

[R-8] Building constraints table with provided values 
[R-7] Checking for optimization function in: c:/PromoGen/Bilal_local_dep/Multippg-Ui updatedbranch/Client_local_RB_promo/RB_PromoGen_R/backend/r_engine/annual_optimization.R 
[R-8] FOUND: optimization() and best_seq() functions exist 
------------------------------------------------------------ 
[R-9] Attempting to call REAL optimization pipeline... 
[R-10] Loading annual_optimization.R and dependencies... 
[R-10a] Loading from: c:/PromoGen/Bilal_local_dep/Multippg-Ui updatedbranch/Client_local_RB_promo/RB_PromoGen_R/backend/r_engine/annual_optimization.R 
[R-11] Loading tesco_slot from Carrefour Slots Excel file... 
       - Loaded tesco_slot from: C:/PromoGen/Bilal_local_dep/Multippg-Ui updatedbranch/Client_local_RB_promo/RB_PromoGen_R/data/Carrefour Slots 2025-2026.xlsx 
       - Columns: Start Date, End Date, Slot 
       - Rows: 36 
       - Date range:  2026-01-06  to  2027-01-05 
[R-11a] Data components loaded: 
       - shiny_opti_data_ip: 936 rows 
       - tesco_slot: 36 slots (transformed) 
       - shiny_ip_events (with Display_Flag): 10510 rows 
       - Columns in shiny_ip_events: PPG, SECTOR 2, TRADING COMPANY, PRODUCT RANGE, FORMAT, PPG_Description, Display, Discount, Display_Cost, Display_Flag ... 
[R-12] Building slot constraints from frontend (Slots Min: 5 , Slots Max: 6 )... 
       - prod_const created for 26 PPGs 
       - Display constraints: Min= 0 , Max= 10 
       - Total slots: Min= 5 , Max= 6 
       - Min_Investment: 836.0 AED 
       - Max_Investment: 8363190.0 AED 
       - Columns: PPG, PRODUCT RANGE, FORMAT, PPG_Description, SECTOR 2, TRADING COMPANY, Min_Disc_Slots, Max_Disc_Slots, Min_Display_Slots, Max_Display_Slots, Min_Display_Weeks, Max_Display_Weeks, Min_Total_Weeks, Max_Total_Weeks, Min_Total_Slots, Max_Total_Slots, Min_Investment, Max_Investment 
[R-13] Building optimization constraints... 
       - gm_min: -1e+20 , gm_max: 1e+20 
       - ts_min: -1e+20 , ts_max: 1e+20 
       - nr_min: 0.0 , nr_max: 1e+20 
       - gs_min: -1e+20 , gs_max: 1e+20 
       - vol_min: -1e+20 , vol_max: 1e+20 
       - gm_abs_min: -1e+20 , gm_abs_max: 1e+20 
       - roi_min: -1e+20 , roi_max: 1e+20 
       - ms_min: -1e+20 , ms_max: 1e+20 
       - opti_const table built ( 6 rows, excluding goal: Gross Margin % of NR ) 
         con 1 : Net_Sales_model : 0 - 1e+20 
         con 2 : Trade_as_per_NR_model : -1e+20 - 1e+20 
         con 3 : Trade_as_per_NIS_model : -1e+20 - 1e+20 
         con 4 : Gross_sales_model : -1e+20 - 1e+20 
         con 5 : Gross_margin_model : -1e+20 - 1e+20 
         con 6 : Volume_sales_model : -1e+20 - 1e+20 
       - Goal: GM%NR - Maximize 
[R-13a] Converting frontend month selection to dates... 
        - Using year from tesco_slot: 2026 
        - Frontend selection: Jan to Apr 
        - Converted to dates: 2026-01-01 to 2026-04-30 
[R-13b] Filtering tesco_slot by date range... 
        - tesco_slot BEFORE filter: 36 rows 
        - tesco_slot AFTER filter: 10 rows 
        - Filtered slot range: 2 to 11 
[R-13c] Final date range: 2026-01-06 to 2026-04-24 
        - shiny_opti_data_ip filtered to: 260 rows 
[R-14] ROI_GM column already exists in events
[R-14] Also created ROI column from ROI_GM for compatibility 
[R-14] Available ROI columns in events: ROI_GM, ROI_Rev, ROI_NIS, ROI 
[R-15] Preparing brand data directly for optimization()...
[COGS-TRACE] brand_data COGS_Unit BEFORE renaming: 0.830310120344872, 3.48973035140026, 6.18409268044287, 1.045891275, 5.59017238541667 
[R-DEBUG] brand_data columns: PPG, SECTOR 2, TRADING COMPANY, PRODUCT RANGE, FORMAT, PPG_Description, Tesco_Week_No, Base_Units, RSP_Unit, Net_Cost_Unit, FM%, COGS_Unit, BIP_Case, OID, No_Of_Units 
[R-DEBUG] brand_data$PPG unique values: D74, D77, D83, D8D, D8F, D8G, D8I, D90, D91, D9N, T03, T09, T15, T16, T18, T19, T60, T68, T70, T71, T73, T74, T75, T76, T77, T78 

[R-14] Preparing prod_const_promo_seq for best_seq()...
        - Found PPGs: D74, D77, D83, D8D, D8F, D8G, D8I, D90, D91, D9N, T03, T09, T15, T16, T18, T19, T60, T68, T70, T71, T73, T74, T75, T76, T77, T78 
        - prod_const_promo_seq columns: PPG, BRAND, FORMAT, Min_Total_Weeks, Max_Total_Weeks, Min_Total_Slots, Max_Total_Slots, Min_Display_Weeks, Max_Display_Weeks, Min_Display_Slots, Max_Display_Slots 
        - prod_const_promo_seq rows: 26 
        - Default Display constraints: Min= 0 , Max= 10 

[R-15] Calling best_seq() to determine optimal promotion sequence...
[R-15a] best_seq() inputs:
        - shiny_opti_data_ip: 260 rows
        - prod_const_promo_seq: 26 rows
        - tesco_slot: 10 rows
        - start_date: 2026-01-06 
        - end_date: 2026-04-24 
[R-15b] best_seq() completed successfully!
        - brand_data rows: 260 
        - brand_data columns: Tesco_Week_No, PPG, SECTOR 2, TRADING COMPANY, PRODUCT RANGE, FORMAT, PPG_Description, Base Sales, RSP (unit), Net Cost (Unit) ...
        - Seq distribution: 0= 182 , 1= 78 
[R-DEBUG] COGS (unit) column found in brand_data - values: 0.830310120344872, 3.48973035140026, 6.18409268044287, 1.045891275, 5.59017238541667 
[R-DEBUG] OID_Unit column found in data
[R-DEBUG] OID_Unit values: min= 0 , max= 0 , sum= 0 
       - brand_data prepared: 260 rows, 23 columns
       - Key columns: Tesco_Week_No, PPG, SECTOR 2, TRADING COMPANY, PRODUCT RANGE, FORMAT, PPG_Description, Base Sales ...

============================================================
       CALLING optimization() FUNCTION
============================================================
Input parameters:
  - brand: 260 rows
  - opti_const: 6 rows
  - prod_const: 26 rows
  - events: 10510 rows
  - goal: GM%NR - Maximize 
  - start_date: 2026-01-06 
  - end_date: 2026-04-24 
============================================================

[R-DEBUG] PPG Parameter from frontend: D77 
[R-DEBUG] PPG values in brand_data: D74, D77, D83, D8D, D8F, D8G, D8I, D90, D91, D9N, T03, T09, T15, T16, T18, T19, T60, T68, T70, T71, T73, T74, T75, T76, T77, T78 
[R-DEBUG] Single PPG detected: D77 
[R-DEBUG] include_ppg_list (final): D77 
[R-DEBUG] include_format: tpr, display 
[R-16a] Preparing opti_const (KPI constraints)...
        - Constraint values from Python (already in correct units):
          NR: min= 0 , max= 1e+20 
          GM%: min= -1e+20 , max= 1e+20 
          TS%NR: min= -1e+20 , max= 1e+20 
          TS%NIS: min= -1e+20 , max= 1e+20 
          GS: min= -1e+20 , max= 1e+20 
          GM(Abs): min= -1e+20 , max= 1e+20 
          Vol: min= -1e+20 , max= 1e+20 
          ROI: min= -1e+20 , max= 1e+20 
          MS: min= -1e+20 , max= 1e+20 
        - Goal KPI to exclude from constraints: Gross Margin % of NR 
[SANITY-GUARD] Goal is GM%NR - ensuring GM > 0 constraint is set
[SANITY-GUARD] Updated Gross Margin minimum from -1e+20 to 0
        - opti_const: 6 rows (dynamically built, excluding goal)
        - KPI Constraints Debug (FINAL VALUES FOR OPTIMIZER):
          con 1 ( Net_Sales_model ): 0 - 1e+20 
          con 2 ( Trade_as_per_NR_model ): -1e+20 - 1e+20 
          con 3 ( Trade_as_per_NIS_model ): -1e+20 - 1e+20 
          con 4 ( Gross_sales_model ): -1e+20 - 1e+20 
          con 5 ( Gross_margin_model ): 0 - 1e+20 
          con 6 ( Volume_sales_model ): -1e+20 - 1e+20 
[R-16b] Preparing prod_budget (budget constraints per PPG)...
        - PPG Descriptions lookup:
          -  D77 :  BAR SOAP-All-120GM-35% 
        - prod_budget: 1 rows
        - Investment constraints: AED 836.0 - 8363190.0 
        - prod_budget columns: PRODUCT RANGE, FORMAT, PPG, PPG_Description, Min_Investment, Max_Investment 
        - prod_budget data:
   PRODUCT RANGE FORMAT    PPG        PPG_Description Min_Investment
          <char> <char> <char>                 <char>          <num>
1:      Bar Soap    ALL    D77 BAR SOAP-All-120GM-35%            836
   Max_Investment
            <num>
1:        8363190
[R-16c] Preparing prod_const (product constraints)...
        - prod_const: 1 rows
        - prod_const columns: PPG, BRAND, FORMAT, LSM_Promo_Price_Min, LSM_Promo_Price_Max, Non_LSM_Min_Promo_Price, Non_LSM_Max_Promo_Price, Min_Disc_Slots, Max_Disc_Slots, Min_Display_Slots, Max_Display_Slots, Min_Total_Slots, Max_Total_Slots, Global_Floor_Price 
        - Display constraints: Min= 0 , Max= 10 
        - Price constraints in prod_const:
          - Non_LSM_Min_Promo_Price: 8 
          - Non_LSM_Max_Promo_Price: 12.33 
[R-16d] Preparing opti_goal...
        - Goal (full name): Gross Margin % of NR 
        - Goal (mapped): GM_percent_model 
        - Direction: Maximize 
        - Run Type: Run Unconstrained Optimization 
        - ROI Type: Incremental GM ROI 
[R-16e] Preparing last_year_kpi (Nielsen data with dates)...
        - Created current_year_date from Week End Date 
        - last_year_kpi: 25084 rows
        - Date range: 2023-12-31 to 2025-12-20 

[R-17] Executing optimization based on mode: unconstrained 
        Run Type from frontend: Run Unconstrained Optimization 
============================================================

[R-17a] Calling event_list() function to filter events by price constraints...
        - Events BEFORE event_list(): 10510 rows
        - Price constraints passed to event_list():
          - Non_LSM_Min_Promo_Price: 8 (from price_min = 8.0 )
          - Non_LSM_Max_Promo_Price: 12.33 (from price_max = 12.33 )
          - LSM_Promo_Price_Min: 8 
          - LSM_Promo_Price_Max: 12.33 
          - Global_Floor_Price: 8 
        - prod_const structure:
      PPG    BRAND FORMAT LSM_Promo_Price_Min LSM_Promo_Price_Max
   <char>   <char> <char>               <num>               <num>
1:    D77 Bar Soap    ALL                   8               12.33
   Non_LSM_Min_Promo_Price Non_LSM_Max_Promo_Price Min_Disc_Slots
                     <num>                   <num>          <int>
1:                       8                   12.33              5
   Max_Disc_Slots Min_Display_Slots Max_Display_Slots Min_Total_Slots
            <int>             <int>             <int>           <int>
1:              6                 0                10               5
   Max_Total_Slots Global_Floor_Price
             <int>              <num>
1:               6                  8
        - event_list() returned:
          - LSM events: 54 rows
          - Non-LSM events: 54 rows
        - Using Non-LSM filtered events for unconstrained optimization
        - Events AFTER event_list() filtering: 54 rows
        - Promo_Price range after filtering: 8 - 12 
        - Sample filtered events:
      PPG  Discount Promo_Price
   <char>     <num>       <num>
1:    D77 0.4160584         8.0
2:    D77 0.3795620         8.5
3:    D77 0.3430657         9.0
4:    D77 0.3065693         9.5
5:    D77 0.2700730        10.0

>>> EXECUTING UNCONSTRAINED OPTIMIZATION (SINGLE PPG) <<<
        Parameters:
        - brand (from best_seq): 260 rows
        - shiny_const (opti_const): 6 rows
        - budget_const (prod_budget): 1 rows
        - events_base: 54 rows
        - ppg_slots (prod_const): 1 rows
        - last_year_kpi: 25084 rows
        - include_format: tpr, display 
        - roi: ROI_GM 
        - include_ppg: D77 
        - start_date: 2026-01-06 
        - end_date: 2026-04-24 

========== OPTIMIZER DATA SUMMARY ==========
Number of weeks in period: Calculating...
PPGs in brand: 1 
PPGs in events: 1 
PPGs in budget: 1 
Total events available: 54 
Excluded PPGs: None 
Included Formats: tpr, display 
Included PPGs: D77  
==========================================


========== STARTING OPTIMIZATION LOOP ==========
Promotion base rows: 3 
Total events to process: 54 
Max iterations pre-allocated: 10000 
==========================================


========== CHECKING DO_CALCULATION OUTPUT ==========
Total_Sales zeros: 0 
Inc_GM_Abs Inf: 0 
Inc_Revenue Inf: 0 
Inc_NIS Inf: 0 
==========================================


--- Budget Status Check for PPG: D77 ---
Budget Status: between 
Budget Details: Status=between, Investment_ppg=5154.52801320709, Min_Inv_Req=836, Max_Inv_Req=8363190 
---

========== EVENT SELECTION SUMMARY ==========
Total events to iterate: 54 
Events by Display Flag:

 0  1 
18 36 
Top 10 events by ROI:
       PPG       ROI Display_Flag  Discount   Display Flyer_Flag
    <char>     <num>        <num>     <num>    <char>      <num>
 1:    D77 0.3537297            1 0.1240876    Half G          0
 2:    D77 0.3536390            0 0.1240876                    1
 3:    D77 0.3484348            1 0.1240876 Staircase          0
 4:    D77 0.3384543            1 0.1240876   Gondola          0
 5:    D77 0.3377401            1 0.1240876    G-Area          0
 6:    D77 0.2439909            1 0.1605839    Half G          0
 7:    D77 0.2439660            0 0.1605839                    1
 8:    D77 0.2416509            1 0.1605839 Staircase          0
 9:    D77 0.2377312            1 0.1605839   Gondola          0
10:    D77 0.2372216            1 0.1605839    G-Area          0
==========================================


========== SETTING UP PARALLEL PROCESSING ==========
Using 4 cores for parallel processing
Generating candidate combinations...
Total candidates to evaluate: 162 
==========================================

Evaluating candidates in parallel...
Batch 1-162: 162 results, 162 non-null
Parallel evaluation complete.
Total results collected: 162 

Non-null results: 162 
Rejection summary:
rejection_reasons
constraints_not_satisfied              not_eligible 
                      147                        15 

No accepted candidates found
Total events processed: 54 
Events with most updates:
==========================================


========== OPTIMIZATION COMPLETE ==========
Total iterations run: 0 
Total replacements attempted: 0 
Total updates accepted: 0 
Total final updates: 0 
Optimization stopped: NO (completed) 
Output rows: 10 
KPI iterations tracked: 0 
==========================================


>>> UNCONSTRAINED OPTIMIZATION COMPLETED <<<

============================================================
       OPTIMIZATION COMPLETED SUCCESSFULLY
       Mode: unconstrained 
============================================================
[CONSTRAINT CHECK] Checking if final output satisfies all constraints...
        Using ACTUAL opti_const table (same as optimizer used):
       Final Net Revenue: 6819.595 
       Final Gross Sales: 11974.12 
       Final GM Abs: 3478.288 
       Final Volume: 0 
       Final GM%: 51 %
       Final TS%NR: 75.58 %
       Final TS%NIS: 43.05 %
       Final ROI: 0.6748 
       con 1 ( Scan Net Revenue ): OK (value= 6819.6 , range=[ 0 , 1e+20 ])
       con 2 ( Trade_as_per_NR_model ): UNCONSTRAINED - skipping
       con 3 ( Trade_as_per_NIS_model ): UNCONSTRAINED - skipping
       con 4 ( Gross_sales_model ): UNCONSTRAINED - skipping
       con 5 ( Gross Margin ): OK (value= 3478.29 , range=[ 0 , 1e+20 ])
       con 6 ( Volume_sales_model ): UNCONSTRAINED - skipping
       All constraints satisfied!
[STORE] Saving optimization result to global 'optimized_output'...
[STORE] Saved to: C:/PromoGen/Bilal_local_dep/Multippg-Ui updatedbranch/Client_local_RB_promo/RB_PromoGen_R/data/optimized_output.RData 
[STORE] optimized_output rows: 10 
[STORE] Dashboard GET endpoints will now return optimized data!
[R-FINAL] Preparing response... 
  Execution mode: REAL best_seq() + optimization() executed successfully 
============================================================ 
[R-14] Response ready. Returning to Python proxy. 
============================================================ 
